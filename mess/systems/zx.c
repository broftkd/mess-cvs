/***************************************************************************
	zx.c

    Orginal driver by:
	Juergen Buchmueller <pullmoll@t-online.de>, Dec 1999

    Fixes and additions by Krzysztof Strzecha:
	07.06.2004 Tape loading added. Some cleanups of debug code.
		   Fixed stupid bug in timings (vblank duration).
		   GAME_NOT_WORKING flag removed.
    	29.05.2004 CPU clock, number of scanlines, vblank duration corrected.
		   Some cleanups. Two non-working TESTDRIVERS added.
    	14.05.2004 Finally fixed and readded.

    To do:
	Tape saving (needs changes in video hardware emulation).
	Some memory areas are not mirrored as they should.
	Video hardware is not fully emulated, so it does not support pseudo
	hi-res and hi-res modes.
	Some memory packs are unemulated.

****************************************************************************/

#include "driver.h"
#include "inputx.h"
#include "vidhrdw/generic.h"
#include "cpu/z80/z80.h"
#include "includes/zx.h"
#include "devices/cassette.h"
#include "formats/zx81_p.h"

/* Memory Maps */

ADDRESS_MAP_START( zx80_map, ADDRESS_SPACE_PROGRAM, 8 )
	AM_RANGE(0x0000, 0x0fff) AM_ROM
	AM_RANGE(0x4000, 0x43ff) AM_RAM
	AM_RANGE(0x8000, 0xffff) AM_NOP
ADDRESS_MAP_END

ADDRESS_MAP_START( zx81_map, ADDRESS_SPACE_PROGRAM, 8 )
	AM_RANGE(0x0000, 0x1fff) AM_ROM
	AM_RANGE(0x4000, 0x43ff) AM_RAM
	AM_RANGE(0x8000, 0xffff) AM_NOP
ADDRESS_MAP_END

ADDRESS_MAP_START( pc8300_map, ADDRESS_SPACE_PROGRAM, 8 )
	AM_RANGE(0x0000, 0x1fff) AM_ROM
	AM_RANGE(0x4000, 0x7fff) AM_RAM	// PC8300 comes with 16K RAM
	AM_RANGE(0x8000, 0xffff) AM_NOP
ADDRESS_MAP_END

static ADDRESS_MAP_START( zx80_io_map, ADDRESS_SPACE_IO, 8 )
	AM_RANGE(0x0000, 0xffff) AM_READWRITE(zx_io_r, zx_io_w)
ADDRESS_MAP_END

/* Input Ports */

INPUT_PORTS_START( zx80 )
    PORT_START_TAG("IN0")
	PORT_DIPNAME( 0x80, 0x00, "16K RAM module" )
	PORT_DIPSETTING(	0x00, DEF_STR( No ) )
	PORT_DIPSETTING(	0x80, DEF_STR( Yes ) )
	PORT_BIT( 0x7e, 0x0f, IPT_UNUSED )

	PORT_START_TAG("IN1")	// KEY ROW 0
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "SHIFT", KEYCODE_LSHIFT, CODE_NONE, UCHAR_SHIFT_1 )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "Z", KEYCODE_Z, CODE_NONE, 'Z' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "X", KEYCODE_X, CODE_NONE, 'X' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "C", KEYCODE_C, CODE_NONE, 'C' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "V", KEYCODE_V, CODE_NONE, 'V' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN2")	// KEY ROW 1
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "A", KEYCODE_A, CODE_NONE, 'A' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "S", KEYCODE_S, CODE_NONE, 'S' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "D", KEYCODE_D, CODE_NONE, 'D' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "F", KEYCODE_F, CODE_NONE, 'F' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "G", KEYCODE_G, CODE_NONE, 'G' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN3")	// KEY ROW 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "Q", KEYCODE_Q, CODE_NONE, 'Q' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "W", KEYCODE_W, CODE_NONE, 'W' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "E", KEYCODE_E, CODE_NONE, 'E' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "R", KEYCODE_R, CODE_NONE, 'R' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "T", KEYCODE_T, CODE_NONE, 'T' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN4")	// KEY ROW 3
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "1 EDIT", KEYCODE_1, CODE_NONE, '1' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "2 AND", KEYCODE_2, CODE_NONE, '2' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "3 THEN", KEYCODE_3, CODE_NONE, '3' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "4 TO", KEYCODE_4, CODE_NONE, '4' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "5 LEFT", KEYCODE_5, CODE_NONE, '5' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN5")	// KEY ROW 4
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "0 RUBOUT", KEYCODE_0, CODE_NONE, '0' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "9 GRAPHICS", KEYCODE_9, CODE_NONE, '9' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "8 RIGHT", KEYCODE_8, CODE_NONE, '8' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "7 UP", KEYCODE_7, CODE_NONE, '7' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "6 DOWN", KEYCODE_6, CODE_NONE, '6' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN6")	// KEY ROW 5
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "P PRINT", KEYCODE_P, CODE_NONE, 'P' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "O POKE", KEYCODE_O, CODE_NONE, 'O' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "I INPUT", KEYCODE_I, CODE_NONE, 'I' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "U IF", KEYCODE_U, CODE_NONE, 'U' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "Y RETURN", KEYCODE_Y, CODE_NONE, 'Y' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN7")	// KEY ROW 6
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "ENTER", KEYCODE_ENTER, CODE_NONE, 13 )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "L", KEYCODE_L, CODE_NONE, 'L' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "K", KEYCODE_K, CODE_NONE, 'K' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "J", KEYCODE_J, CODE_NONE, 'J' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "H", KEYCODE_H, CODE_NONE, 'H' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN8")	// KEY ROW 7
	PORT_KEY2( 0x01, IP_ACTIVE_LOW, "SPACE £", KEYCODE_SPACE, CODE_NONE, ' ', '£' )
	PORT_KEY2( 0x02, IP_ACTIVE_LOW, ". ,", KEYCODE_STOP, CODE_NONE, '.', ',' )
	PORT_KEY2( 0x04, IP_ACTIVE_LOW, "M >", KEYCODE_M, CODE_NONE, 'M', '>' )
	PORT_KEY2( 0x08, IP_ACTIVE_LOW, "N >", KEYCODE_N, CODE_NONE, 'N', '<' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "B", KEYCODE_B, CODE_NONE, 'B' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN9")	// special keys 1
	PORT_BIT( 0x0f, IP_ACTIVE_LOW, IPT_UNUSED )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "\x1b", KEYCODE_LEFT, CODE_NONE, UCHAR_MAMEKEY(LEFT) ) 
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN10")	// special keys 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "BACKSPACE", KEYCODE_BACKSPACE, CODE_NONE, 8 ) 
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "GRAPHICS", KEYCODE_LALT, CODE_NONE, UCHAR_SHIFT_2 )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "\x1a", KEYCODE_RIGHT, CODE_NONE, UCHAR_MAMEKEY(RIGHT) ) 
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "\x18", KEYCODE_UP, CODE_NONE, UCHAR_MAMEKEY(UP) ) 
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "\x19", KEYCODE_DOWN, CODE_NONE, UCHAR_MAMEKEY(DOWN) ) 
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )
INPUT_PORTS_END

INPUT_PORTS_START( zx81 )
    PORT_START_TAG("IN0")
	PORT_DIPNAME( 0x80, 0x00, "16K RAM module" )
	PORT_DIPSETTING(	0x00, DEF_STR( No ) )
	PORT_DIPSETTING(	0x80, DEF_STR( Yes ) )
	PORT_BIT( 0x7e, 0x0f, IPT_UNUSED )

	PORT_START_TAG("IN1")	// KEY ROW 0
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "SHIFT", KEYCODE_LSHIFT, CODE_NONE, UCHAR_SHIFT_1 )
	PORT_KEY2( 0x02, IP_ACTIVE_LOW, "Z :", KEYCODE_Z, CODE_NONE, 'Z', ':' )
	PORT_KEY2( 0x04, IP_ACTIVE_LOW, "X ;", KEYCODE_X, CODE_NONE, 'X', ';' )
	PORT_KEY2( 0x08, IP_ACTIVE_LOW, "C ?", KEYCODE_C, CODE_NONE, 'C', '?' )
	PORT_KEY2( 0x10, IP_ACTIVE_LOW, "V /", KEYCODE_V, CODE_NONE, 'V', '/' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN2")	// KEY ROW 1
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "A NEW STOP", KEYCODE_A, CODE_NONE, 'A' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "S SAVE LPRINT", KEYCODE_S, CODE_NONE, 'S' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "D DIM SLOW", KEYCODE_D, CODE_NONE, 'D' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "F FOR FAST", KEYCODE_F, CODE_NONE, 'F' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "G GOTO LLIST", KEYCODE_G, CODE_NONE, 'G' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN3")	// KEY ROW 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "Q PLOT \"\"", KEYCODE_Q, CODE_NONE, 'Q' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "W UNPLOT OR", KEYCODE_W, CODE_NONE, 'W' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "E REM STEP", KEYCODE_E, CODE_NONE, 'E' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "R RUN <=", KEYCODE_R, CODE_NONE, 'R' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "T RAND <>", KEYCODE_T, CODE_NONE, 'T' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN4")	// KEY ROW 3
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "1 EDIT", KEYCODE_1, CODE_NONE, '1' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "2 AND", KEYCODE_2, CODE_NONE, '2' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "3 THEN", KEYCODE_3, CODE_NONE, '3' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "4 TO", KEYCODE_4, CODE_NONE, '4' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "5 LEFT", KEYCODE_5, CODE_NONE, '5' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN5")	// KEY ROW 4
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "0 RUBOUT", KEYCODE_0, CODE_NONE, '0' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "9 GRAPHICS", KEYCODE_9, CODE_NONE, '9' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "8 RIGHT", KEYCODE_8, CODE_NONE, '8' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "7 UP", KEYCODE_7, CODE_NONE, '7' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "6 DOWN", KEYCODE_6, CODE_NONE, '6' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN6")	// KEY ROW 5
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "P PRINT \"", KEYCODE_P, CODE_NONE, 'P' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "O POKE )", KEYCODE_O, CODE_NONE, 'O' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "I INPUT (", KEYCODE_I, CODE_NONE, 'I' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "U IF $", KEYCODE_U, CODE_NONE, 'U' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "Y RETURN >=", KEYCODE_Y, CODE_NONE, 'Y' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN7")	// KEY ROW 6
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "ENTER", KEYCODE_ENTER, CODE_NONE, 13 )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "L LET =", KEYCODE_L, CODE_NONE, 'L' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "K LIST +", KEYCODE_K, CODE_NONE, 'K' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "J LOAD -", KEYCODE_J, CODE_NONE, 'J' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "H GOSUB **", KEYCODE_H, CODE_NONE, 'H' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN8")	// KEY ROW 7
	PORT_KEY2( 0x01, IP_ACTIVE_LOW, "SPACE £", KEYCODE_SPACE, CODE_NONE, ' ', '£' )
	PORT_KEY2( 0x02, IP_ACTIVE_LOW, ". ,", KEYCODE_STOP, CODE_NONE, '.', ',' )
	PORT_KEY2( 0x04, IP_ACTIVE_LOW, "M PAUSE >", KEYCODE_M, CODE_NONE, 'M', '>' )
	PORT_KEY2( 0x08, IP_ACTIVE_LOW, "N NEXT >", KEYCODE_N, CODE_NONE, 'N', '<' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "B SCROLL *", KEYCODE_B, CODE_NONE, 'B' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN9")	// special keys 1
	PORT_BIT( 0x0f, IP_ACTIVE_LOW, IPT_UNUSED )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "\x1b", KEYCODE_LEFT, CODE_NONE, UCHAR_MAMEKEY(LEFT) ) 
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN10")	// special keys 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "BACKSPACE", KEYCODE_BACKSPACE, CODE_NONE, 8 ) 
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "GRAPHICS", KEYCODE_LALT, CODE_NONE, UCHAR_SHIFT_2 )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "\x1a", KEYCODE_RIGHT, CODE_NONE, UCHAR_MAMEKEY(RIGHT) ) 
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "\x18", KEYCODE_UP, CODE_NONE, UCHAR_MAMEKEY(UP) ) 
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "\x19", KEYCODE_DOWN, CODE_NONE, UCHAR_MAMEKEY(DOWN) ) 
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )
INPUT_PORTS_END

INPUT_PORTS_START( pow3000 )
	PORT_START_TAG("IN0")
	PORT_BIT( 0xfe, 0x0f, IPT_UNUSED )

	PORT_START_TAG("IN1")	// KEY ROW 0
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "SHIFT", KEYCODE_LSHIFT, CODE_NONE, UCHAR_SHIFT_1 )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "Z", KEYCODE_Z, CODE_NONE, 'Z' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "X", KEYCODE_X, CODE_NONE, 'X' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "C", KEYCODE_C, CODE_NONE, 'C' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "V", KEYCODE_V, CODE_NONE, 'V' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN2")	// KEY ROW 1
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "A", KEYCODE_A, CODE_NONE, 'A' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "S", KEYCODE_S, CODE_NONE, 'S' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "D", KEYCODE_D, CODE_NONE, 'D' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "F", KEYCODE_F, CODE_NONE, 'F' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "G", KEYCODE_G, CODE_NONE, 'G' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN3")	// KEY ROW 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "Q", KEYCODE_Q, CODE_NONE, 'Q' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "W", KEYCODE_W, CODE_NONE, 'W' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "E", KEYCODE_E, CODE_NONE, 'E' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "R", KEYCODE_R, CODE_NONE, 'R' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "T", KEYCODE_T, CODE_NONE, 'T' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN4")	// KEY ROW 3
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "1", KEYCODE_1, CODE_NONE, '1' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "2", KEYCODE_2, CODE_NONE, '2' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "3", KEYCODE_3, CODE_NONE, '3' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "4", KEYCODE_4, CODE_NONE, '4' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "5", KEYCODE_5, CODE_NONE, '5' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN5")	// KEY ROW 4
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "0", KEYCODE_0, CODE_NONE, '0' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "9", KEYCODE_9, CODE_NONE, '9' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "8", KEYCODE_8, CODE_NONE, '8' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "7", KEYCODE_7, CODE_NONE, '7' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "6", KEYCODE_6, CODE_NONE, '6' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN6")	// KEY ROW 5
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "P", KEYCODE_P, CODE_NONE, 'P' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "O", KEYCODE_O, CODE_NONE, 'O' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "I", KEYCODE_I, CODE_NONE, 'I' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "U", KEYCODE_U, CODE_NONE, 'U' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "Y", KEYCODE_Y, CODE_NONE, 'Y' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN7")	// KEY ROW 6
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "ENTER", KEYCODE_ENTER, CODE_NONE, 13 )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "L", KEYCODE_L, CODE_NONE, 'L' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "K", KEYCODE_K, CODE_NONE, 'K' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "J", KEYCODE_J, CODE_NONE, 'J' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "H", KEYCODE_H, CODE_NONE, 'H' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN8")	// KEY ROW 7
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "SPACE", KEYCODE_SPACE, CODE_NONE, ' ' )
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, ".", KEYCODE_STOP, CODE_NONE, '.' )
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "M", KEYCODE_M, CODE_NONE, 'M' )
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "N", KEYCODE_N, CODE_NONE, 'N' )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "B", KEYCODE_B, CODE_NONE, 'B' )
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN9")	// special keys 1
	PORT_BIT( 0x0f, IP_ACTIVE_LOW, IPT_UNUSED )
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "\x1b", KEYCODE_LEFT, CODE_NONE, UCHAR_MAMEKEY(LEFT) ) 
	PORT_BIT( 0xe0, IP_ACTIVE_LOW, IPT_UNUSED )

	PORT_START_TAG("IN10")	// special keys 2
	PORT_KEY1( 0x01, IP_ACTIVE_LOW, "\x18", KEYCODE_UP, CODE_NONE, UCHAR_MAMEKEY(UP) ) 
	PORT_KEY1( 0x02, IP_ACTIVE_LOW, "\x19", KEYCODE_DOWN, CODE_NONE, UCHAR_MAMEKEY(DOWN) ) 
	PORT_KEY1( 0x04, IP_ACTIVE_LOW, "\x1a", KEYCODE_RIGHT, CODE_NONE, UCHAR_MAMEKEY(RIGHT) ) 
	PORT_KEY1( 0x08, IP_ACTIVE_LOW, "BACKSPACE", KEYCODE_BACKSPACE, CODE_NONE, 8 ) 
	PORT_KEY1( 0x10, IP_ACTIVE_LOW, "GRAPHICS", KEYCODE_LALT, CODE_NONE, UCHAR_SHIFT_2 )
	PORT_BIT(0xe0, IP_ACTIVE_LOW, IPT_UNUSED)
INPUT_PORTS_END

/* Graphics Layouts */

static struct GfxLayout zx_pixel_layout =
{
	8, 1,							   /* 8x1 pixels */
	256,							   /* 256 codes */
	1,								   /* 1 bit per pixel */
	{0},							   /* no bitplanes */
	/* x offsets */
	{0, 1, 2, 3, 4, 5, 6, 7},
	/* y offsets */
	{0},
	8								   /* one byte per code */
};

static struct GfxLayout zx_char_layout =
{
	8, 8,							   /* 8x8 pixels */
	64,								   /* 64 codes */
	1,								   /* 1 bit per pixel */
	{0},							   /* no bitplanes */
	/* x offsets */
	{0, 1, 2, 3, 4, 5, 6, 7},
	/* y offsets */
	{0 * 8, 1 * 8, 2 * 8, 3 * 8, 4 * 8, 5 * 8, 6 * 8, 7 * 8},
	8 * 8							   /* eight bytes per code */
};

/* Graphics Decode Information */

static struct GfxDecodeInfo zx80_gfxdecodeinfo[] =
{
	{ REGION_GFX1, 0x0000, &zx_pixel_layout, 0, 2 },
	{ REGION_CPU1, 0x0e00, &zx_char_layout,  0, 2 },
	{ -1 }
};

static struct GfxDecodeInfo zx81_gfxdecodeinfo[] =
{
	{ REGION_GFX1, 0x0000, &zx_pixel_layout, 0, 2 },
	{ REGION_CPU1, 0x1e00, &zx_char_layout,  0, 2 },
	{ -1 }
};

static struct GfxDecodeInfo pc8300_gfxdecodeinfo[] =
{
	{ REGION_GFX1, 0x0000, &zx_pixel_layout, 0, 2 },
	{ REGION_GFX2, 0x0000, &zx_char_layout,  0, 2 },
	{ -1 }
};

static struct GfxDecodeInfo pow3000_gfxdecodeinfo[] =
{
	{ REGION_GFX1, 0x0000, &zx_pixel_layout, 0, 2 },
	{ REGION_GFX2, 0x0000, &zx_char_layout,  0, 2 },
	{ -1 }
};

/* Palette Initialization */

static unsigned char zx80_palette[] =
{
	255,255,255,	/* white */
	  0,  0,  0,	/* black */
};

static unsigned char zx81_palette[] =
{
	255,255,255,	/* white */
	  0,  0,  0,	/* black */
};

static unsigned char ts1000_palette[] =
{
	 64,244,244,	/* cyan */
	  0,  0,  0,	/* black */
};

static unsigned short zx_colortable[] =
{
	0, 1,							   /* white on black */
	1, 0							   /* black on white */
};

static PALETTE_INIT( zx80 )
{
	palette_set_colors(0, zx80_palette, sizeof(zx80_palette) / 3);
	memcpy(colortable, zx_colortable, sizeof (zx_colortable));
}

static PALETTE_INIT( zx81 )
{
	palette_set_colors(0, zx81_palette, sizeof(zx81_palette) / 3);
	memcpy(colortable, zx_colortable, sizeof (zx_colortable));
}

static PALETTE_INIT( ts1000 )
{
	palette_set_colors(0, ts1000_palette, sizeof(ts1000_palette) / 3);
	memcpy(colortable, zx_colortable, sizeof (zx_colortable));
}

static struct Wave_interface zx81_wave_interface = {
	1,		/* 1 cassette recorder */
	{50}		/* mixing levels in percent */
};

static struct DACinterface zx81_dac_interface =
{
	1,		/* number of DACs */
	{50}		/* volume */
};

#define ZX81_CPU_CLOCK			3250000
#define ZX81_CYCLES_PER_SCANLINE	207
#define ZX81_PIXELS_PER_SCANLINE	256
#define ZX81_CYCLES_PER_VBLANK		1235
#define ZX81_VBLANK_DURATION		(1.0*ZX81_CYCLES_PER_VBLANK/ZX81_CPU_CLOCK*1000*1000)

#define ZX81_PAL_SCANLINES		304
#define ZX81_PAL_FRAMES_PER_SECOND	(1.0*ZX81_CPU_CLOCK/(ZX81_PAL_SCANLINES*ZX81_CYCLES_PER_SCANLINE+ZX81_CYCLES_PER_VBLANK))

#define ZX81_NTSC_SCANLINES		256
#define ZX81_NTSC_FRAMES_PER_SECOND	(1.0*ZX81_CPU_CLOCK/(ZX81_NTSC_SCANLINES*ZX81_CYCLES_PER_SCANLINE+ZX81_CYCLES_PER_VBLANK))

/* Machine Drivers */

static MACHINE_DRIVER_START( zx80 )
	// basic machine hardware
	MDRV_CPU_ADD_TAG("main", Z80, ZX81_CPU_CLOCK)
	MDRV_CPU_FLAGS(CPU_16BIT_PORT)
	MDRV_CPU_PROGRAM_MAP(zx80_map, 0)
	MDRV_CPU_IO_MAP(zx80_io_map, 0)
	MDRV_FRAMES_PER_SECOND(ZX81_PAL_FRAMES_PER_SECOND)
	MDRV_VBLANK_DURATION(ZX81_VBLANK_DURATION)

	MDRV_MACHINE_INIT(zx80)

    // video hardware
	MDRV_VIDEO_ATTRIBUTES(VIDEO_TYPE_RASTER)
	MDRV_SCREEN_SIZE(ZX81_PIXELS_PER_SCANLINE, ZX81_PAL_SCANLINES)
	MDRV_VISIBLE_AREA(0, ZX81_PIXELS_PER_SCANLINE-1, 0, ZX81_PAL_SCANLINES-1)
	MDRV_GFXDECODE(zx80_gfxdecodeinfo)
	MDRV_PALETTE_LENGTH(6)
	MDRV_COLORTABLE_LENGTH(4)
	MDRV_PALETTE_INIT(zx80)

	MDRV_VIDEO_START(zx)
	MDRV_VIDEO_UPDATE(zx)

	// sound hardware
	MDRV_SOUND_ADD(WAVE, zx81_wave_interface)
	MDRV_SOUND_ADD(DAC, zx81_dac_interface)
MACHINE_DRIVER_END

static MACHINE_DRIVER_START( zx81 )
	MDRV_IMPORT_FROM(zx80)

	MDRV_CPU_MODIFY("main")
	MDRV_CPU_PROGRAM_MAP(zx81_map, 0)

	MDRV_MACHINE_INIT(zx81)

	MDRV_GFXDECODE(zx81_gfxdecodeinfo)
	MDRV_PALETTE_INIT(zx81)
MACHINE_DRIVER_END

static MACHINE_DRIVER_START( ts1000 )
	MDRV_IMPORT_FROM(zx81)

	MDRV_FRAMES_PER_SECOND(ZX81_NTSC_FRAMES_PER_SECOND)

	MDRV_SCREEN_SIZE(ZX81_PIXELS_PER_SCANLINE, ZX81_NTSC_SCANLINES)
	MDRV_VISIBLE_AREA(0, ZX81_PIXELS_PER_SCANLINE-1, 0, ZX81_NTSC_SCANLINES-1)
	MDRV_PALETTE_INIT(ts1000)
MACHINE_DRIVER_END

static MACHINE_DRIVER_START( pc8300 )
	MDRV_IMPORT_FROM(ts1000)

	MDRV_CPU_MODIFY("main")
	MDRV_CPU_PROGRAM_MAP(pc8300_map, 0)

	MDRV_MACHINE_INIT(pc8300)
	MDRV_GFXDECODE(pc8300_gfxdecodeinfo)
	MDRV_PALETTE_INIT(zx81)
MACHINE_DRIVER_END

static MACHINE_DRIVER_START( pow3000 )
	MDRV_IMPORT_FROM(ts1000)

	MDRV_CPU_MODIFY("main")
	MDRV_CPU_PROGRAM_MAP(pc8300_map, 0)

	MDRV_MACHINE_INIT(pc8300)
	MDRV_GFXDECODE(pow3000_gfxdecodeinfo)
	MDRV_PALETTE_INIT(zx81)
MACHINE_DRIVER_END

/* ROMs */

ROM_START(zx80)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "zx80.rom", 0x0000, 0x1000, CRC(4c7fc597) SHA1(b6769a3197c77009e0933e038c15b43cf4c98c7a) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END

ROM_START(aszmic)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "aszmic.rom", 0x0000, 0x1000, CRC(6c123536) SHA1(720867cbfafafc8c7438bbc325a77eaef571e5c0) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END

ROM_START(zx81)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "zx81.rom", 0x0000, 0x2000, CRC(fcbbd617) SHA1(a0ade36540561cc1691bb6f0c42ceae12484a102) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END                                                                                                                                       

ROM_START(zx81a)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "zx81a.rom", 0x0000, 0x2000, CRC(4b1dd6eb) SHA1(7b143ee964e9ada89d1f9e88f0bd48d919184cfc) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END

ROM_START(zx81b)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "zx81b.rom", 0x0000, 0x2000, CRC(522c37b8) SHA1(c6d8e06cb936989f6e1cc7a56d1f092da854a515) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END                                                                                                                                       

ROM_START(h4th)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "h4th.rom", 0x0000, 0x2000, CRC(257d5a32) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END                                                                                                                                       

ROM_START(tree4th)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "tree4th.rom", 0x0000, 0x2000, CRC(71616238) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END                                                                                                                                       

ROM_START(ts1000)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "zx81a.rom", 0x0000, 0x2000, CRC(4b1dd6eb) SHA1(7b143ee964e9ada89d1f9e88f0bd48d919184cfc) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver
ROM_END

ROM_START(pc8300)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD( "8300_org.rom", 0x0000, 0x2000, CRC(a350f2b1) SHA1(6a9be484556cc27a9cd9d71085d2027c6243333f) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver

	ROM_REGION( 0x200, REGION_GFX2, 0 )
	ROM_LOAD( "8300_fnt.bin",0x0000, 0x0200, CRC(6bd0408c) SHA1(34a7a5afee511dc8bba28eccf305c873d80a557a) )
ROM_END

ROM_START(pow3000)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD("pow3000.rom", 0x0000, 0x2000, CRC(8a49b2c3) SHA1(9b22daf2f3a991aa6a358ef95b091654c3ca1bdf) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver

	ROM_REGION( 0x200, REGION_GFX2, 0 )
	ROM_LOAD( "pow3000.chr", 0x0000, 0x0200, CRC(1c42fe46) SHA1(5b30ba77c8f57065d106db69964c9ff2e4221760) )
ROM_END

ROM_START(lambda)
	ROM_REGION( 0x10000, REGION_CPU1,0 )
	ROM_LOAD("lambda.rom", 0x0000, 0x2000, CRC(8a49b2c3) SHA1(9b22daf2f3a991aa6a358ef95b091654c3ca1bdf) )

	ROM_REGION( 0x100, REGION_GFX1, 0 )
	// filled in by zx_init_driver

	ROM_REGION( 0x200, REGION_GFX2, 0 )
	ROM_LOAD( "8300_fnt.bin", 0x0000, 0x0200, CRC(6bd0408c) SHA1(34a7a5afee511dc8bba28eccf305c873d80a557a) )
ROM_END                                                                                                                                       

/* System Configuration */

static struct CassetteOptions zx81_cassette_options = {
	1,		/* channels */
	16,		/* bits per sample */
	44100		/* sample frequency */
};

SYSTEM_CONFIG_START(zx80)
	CONFIG_DEVICE_CASSETTEX(1, zx80_o_format, &zx81_cassette_options, CASSETTE_STOPPED | CASSETTE_SPEAKER_ENABLED)
SYSTEM_CONFIG_END

SYSTEM_CONFIG_START(zx81)
	CONFIG_DEVICE_CASSETTEX(1, zx81_p_format, &zx81_cassette_options, CASSETTE_STOPPED | CASSETTE_SPEAKER_ENABLED)
SYSTEM_CONFIG_END

/* Game Drivers */

//	YEAR	NAME	 PARENT	COMPAT	MACHINE	INPUT	INIT	CONFIG	COMPANY				FULLNAME
COMP (	1980,	zx80,    0,	0,	zx80,	zx80,	zx,	zx80,	"Sinclair Research",		"ZX-80" )
COMP (	1981,	aszmic,  zx80,	0,	zx80,	zx80,	zx,	zx80,	"Sinclair Research",		"ZX.Aszmic" )
COMP (	1981,	zx81,    0,	0,	zx81,	zx81,   zx,	zx81,	"Sinclair Research",		"ZX-81" )
COMP (	198?,	zx81a,   zx81,	0,	zx81,	zx81,	zx,	zx81,	"Sinclair Research",		"ZX-81 (2nd rev)" )
COMP (	198?,	zx81b,   zx81,	0,	zx81,	zx81,	zx,	zx81,	"Sinclair Research",		"ZX-81 (3rd rev)" )
COMPX(	198?,	h4th,	zx81,	0,	zx81,	zx81,	zx,	zx81,	"Sinclair Research",		"Sinclair ZX-81 Forth by David Husband",	GAME_NOT_WORKING)
COMPX(	198?,	tree4th,zx81,	0,	zx81,	zx81,	zx,	zx81,	"Sinclair Research",		"Sinclair ZX-81 Tree-Forth by Tree Systems",	GAME_NOT_WORKING)
COMP (	1982,	ts1000,  zx81,	0,	ts1000,	zx81,	zx,	zx81,	"Timex Sinclair",		"Timex Sinclair 1000" )
COMP (	1984,	pc8300,  zx81,	0,	pc8300,	pow3000,zx,	zx81,	"Your Computer",		"PC8300" )
COMP (	1983,	pow3000, zx81,	0,	pow3000,pow3000,zx,	zx81,	"Creon Enterprises",		"Power 3000" )
COMP (	1982,	lambda,  zx81,	0,	pc8300,	pow3000,zx,	zx81,	"Lambda Electronics Ltd",	"Lambda 8300" )
